/*fed6fd30c84cf155038fa04ec86175f14a454ad9*/Ext.define("Judge.view.Articles",{id:"ArticlesView",extend:"Ext.dataview.NestedList",xtype:"articles",requires:["Ext.carousel.Carousel"],config:{title:"Статьи",iconCls:"star",listConfig:{itemTpl:'<div class="judge-list-item"><tpl if="img"><img src="{img}"/></tpl><h4>{title}</h4><small>{description}</small></div>'},updateTitleText:false,detailCard:{xtype:"carousel",scrollable:{direction:"vertical",directionLock:true},styleHtmlContent:true,indicator:false}}});Ext.define("Judge.view.About",{id:"AboutView",extend:"Ext.dataview.NestedList",xtype:"about",config:{title:"Информация",iconCls:"info",listConfig:{itemTpl:'<div class="judge-list-item"><tpl if="img"><img src="{img}"/></tpl><h4>{title}</h4><small>{description}</small></div>'},detailCard:{xtype:"container",scrollable:{direction:"vertical",directionLock:true},styleHtmlContent:true}}});Ext.define("Judge.view.NewsList",{extend:"Ext.dataview.NestedList",xtype:"newslist",id:"newsList",requires:["Ext.carousel.Carousel"],config:{title:"Новости",iconCls:"time",listConfig:{itemTpl:'<div class="judge-list-item"><tpl if="img"><img src="{img}"/></tpl><h4>{title}</h4><small>{description}</small></div>'},updateTitleText:false,detailCard:{xtype:"carousel",scrollable:{direction:"vertical",directionLock:true},styleHtmlContent:true,indicator:false}}});Ext.define("Judge.model.LoginModel",{extend:"Ext.data.Model",config:{fields:["name","password","uniqkey"]}});Ext.define("Judge.controller.FileProvider",{config:{appDirectory:"magazines",fileExt:".txt",objectToWrite:undefined,getFileErrorCallback:undefined,createFile:true,isWriteAccess:false,fileName:undefined,writeCallback:undefined,readCallback:undefined},fileSystemError:function(){Ext.Msg.alert("Ошибка","Ошибка в доступе к файловой системе. Убедитесь в наличии свободного места.")},deleteFile:function(a){this.processFile(a)},processFile:function(a){var f=Ext.Viewport.getComponent("loading");if(f!=null){f.show()}var d=this;if(window.LocalFileSystem){window.requestFileSystem(window.LocalFileSystem.PERSISTENT,0,e,this.fileSystemError)}function e(g){g.root.getDirectory(d.appDirectory,{create:true,exclusive:false},h,d.fileSystemError);function h(i){i.getFile(d.fileName+d.fileExt,{create:d.createFile,exclusive:false},c,b)}}function b(){Ext.Viewport.getComponent("loading").hide();d.getFileErrorCallback?d.getFileErrorCallback():d.fileSystemError()}function c(g){if(a){g.remove(function(){a.call();Ext.Viewport.getComponent("loading").hide()});return}d.isWriteAccess?d.writeFile.call(d,g):d.readFile.call(d,g)}},readFile:function(c){var b=this;var a=new FileReader();a.onloadend=function(d){Ext.Viewport.getComponent("loading").hide();if(b.readCallback){b.readCallback(d)}};a.readAsText(c)},writeFile:function(c){var b=this;c.createWriter(a,this.fileSystemError);function a(d){d.onwriteend=function(e){Ext.Viewport.getComponent("loading").hide();if(b.writeCallback){b.writeCallback()}};d.write(b.objectToWrite)}},constructor:function(b){for(var a in b){this.config[a]=b[a]}for(var c in this.config){this[c]=this.config[c]}this.config=null;return this}});Ext.define("Judge.model.ListModel",{extend:"Ext.data.Model",config:{fields:["id","pagetitle","description","img","content","data"],hasMany:{model:"Judge.model.ListItemModel",name:"data"},proxy:{type:"ajax",url:"http://evestnik.by/export.html",reader:{type:"json"}}}});Ext.define("Judge.model.ListItemModel",{extend:"Ext.data.Model",config:{fields:["id","title","description","img","content",{name:"leaf",type:"boolean"},"list"],belongsTo:"Judge.model.ListModel",hasMany:{model:"Judge.model.ListItemModel",name:"list"}}});Ext.define("Judge.view.Login",{extend:"Ext.form.Panel",id:"LoginPanel",xtype:"login",requires:["Ext.TitleBar","Ext.form.FieldSet","Ext.field.Email","Ext.field.Password","Judge.model.LoginModel"],config:{title:"Вход",scrollable:true,items:[{xtype:"fieldset",title:"Вход",instructions:"Для входа в систему введите логин и нажмите вход",items:[{xtype:"emailfield",label:"Логин",placeHolder:"email@example.com",name:"user",required:true,id:"txtEmail"}]},{xtype:"container",layout:"hbox",items:[{xtype:"button",text:"Вход",ui:"confirm",flex:1,id:"btnSubmit"},{xtype:"spacer",flex:1},{xtype:"button",text:"Отмена",flex:1,id:"btnCancel"}]}]}});Ext.define("Judge.view.Register",{extend:"Ext.form.Panel",id:"RegisterPanel",xtype:"register",requires:["Ext.TitleBar","Ext.form.FieldSet","Ext.field.Email","Ext.field.Password","Judge.model.LoginModel"],config:{title:"Регистрация",scrollable:true,items:[{xtype:"fieldset",title:"Регистрация",instructions:"Для регистрации в системе введите логин и нажмите Регистрация",items:[{xtype:"emailfield",label:"Логин",placeHolder:"email@example.com",name:"regEmail",required:true,id:"txtRegEmail"}]},{xtype:"container",layout:"hbox",items:[{xtype:"button",text:"Регистрация",ui:"confirm",flex:1,id:"btnRegister"},{xtype:"spacer",flex:1},{xtype:"button",text:"Отмена",flex:1,id:"btnRegisterCancel"}]}]}});Ext.define("Judge.view.MagazinesAvailableList",{extend:"Ext.dataview.List",xtype:"availablelist",id:"AvailableList",config:{title:"Доступные",itemTpl:'<div class="judge-list-item"><tpl if="img"><img src="{img}"/></tpl><h4>{title}</h4><small>{description}</small></div>',items:[{xtype:"titlebar",docked:"top",title:"Доступные",ui:"light"}]}});Ext.define("Judge.view.MagazinesDownloadedList",{extend:"Ext.dataview.List",xtype:"downloadedlist",id:"DownloadedList",config:{title:"Скачанные",itemTpl:'<div class="judge-list-item"><tpl if="img"><img src="{img}"/></tpl><h4>{title}</h4><small>{description}</small></div>',items:[{xtype:"titlebar",docked:"top",title:"Скачанные",ui:"light"}]}});Ext.define("Judge.view.MagazineEntry",{extend:"Ext.dataview.NestedList",xtype:"magazineentry",id:"MagazineEntry",config:{title:"Журнал",backText:"Назад",useTitleAsBackText:false,listConfig:{itemTpl:'<div class="judge-list-item"><tpl if="img"><div class="img-container" style="background: url({img}) center no-repeat; background-size:cover;"></div></tpl><h4>{title}</h4></div>'},detailCard:{xtype:"container",scrollable:{direction:"vertical",directionLock:true},styleHtmlContent:true,layout:"fit",listeners:{show:function(a){this.getScrollable().getScroller().refresh();this.getScrollable().getScroller().scrollTo(0,0)}}},toolbar:{docked:"top",xtype:"titlebar",ui:"light",inline:true,items:[{xtype:"button",id:"btnGoToMagazines",iconCls:"reply",iconMask:true,align:"right"}]}}});Ext.define("Judge.model.EntryModel",{extend:"Ext.data.Model",config:{fields:["id","title","headline","content"],proxy:{type:"ajax",url:"http://evestnik.by/export.html",reader:{type:"json"}}}});Ext.define("Judge.controller.LoginController",{extend:Ext.app.Controller,requires:["Judge.model.LoginModel"],config:{refs:{panelMagazine:"#magazinePanel",loginForm:"#LoginPanel",btnSubmit:"#btnSubmit",btnCancel:"#btnCancel",txtEmail:"#txtEmail",btnRegister:"#btnRegister",btnRegisterCancel:"#btnRegisterCancel",txtRegEmail:"#txtRegEmail"},control:{btnSubmit:{tap:"onSubmit"},btnCancel:{tap:"onCancel"},btnRegister:{tap:"onRegister"},btnRegisterCancel:{tap:"onRegisterCancel"}}},emailValidator:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,onSubmit:function(){var b=this;var a=this.getTxtEmail().getValue();if(this.emailValidator.test(a)){if(navigator.network&&navigator.network.connection&&navigator.network.connection.type!=Connection.NONE){Ext.Ajax.request({url:"http://evestnik.by/user.html",method:"POST",params:{user:a,key:"abc"},success:function(c){if(c.responseText=="1"){var d=b.getApplication().getController("MagazinesAvailableController");d.loggedIn=true;d.loadData();b.getPanelMagazine().setActiveItem(1)}else{Ext.Msg.alert("Ошибка","Введен неверный логин либо аккаунт не активирован.")}},failure:function(){Ext.Msg.alert("Ошибка","Вход невозможен. Ошибка подключения.")}})}else{Ext.Msg.alert("Ошибка","Вход невозможен. Отсутствует подключение к интернету.")}}else{Ext.Msg.alert("Ошибка","Введен неверный логин.")}},onCancel:function(){this.getPanelMagazine().setActiveItem(1)},onRegister:function(){var b=this;var a=this.getTxtRegEmail().getValue();if(this.emailValidator.test(a)){if(navigator.network&&navigator.network.connection&&navigator.network.connection.type!=Connection.NONE){Ext.Ajax.request({url:"http://evestnik.by/reg.html",method:"POST",params:{user:a,key:device.uuid},success:function(c){Ext.Msg.alert("Ошибка","Регистрация прошла успешно. Ожидайте активации аккаунта.");b.getPanelMagazine().setActiveItem(1)},failure:function(){Ext.Msg.alert("Ошибка","Регистрация невозможна. Ошибка подключения.")}})}else{Ext.Msg.alert("Ошибка","Регистрация невозможна. Отсутствует подключение к интернету.")}}else{Ext.Msg.alert("Ошибка","Введен неверный логин.")}},onRegisterCancel:function(){this.getPanelMagazine().setActiveItem(1)}});Ext.define("Judge.controller.MagazineEntryController",{extend:"Ext.app.Controller",requires:["Judge.model.ListModel","Judge.model.ListItemModel"],config:{refs:{nestedList:"#MagazineEntry",btnGoToMagazines:"#btnGoToMagazines",panelMagazine:"#magazinePanel"},control:{nestedList:{itemtap:"onItemTap",back:"onBack"},btnGoToMagazines:{tap:"goToMagazines"}}},onItemTap:function(e,d,a,c,b){this.getBtnGoToMagazines().hide();if(b.get("leaf")==true){e.getDetailCard().setHtml(b.get("content"))}},goToMagazines:function(){this.getPanelMagazine().setActiveItem(1)},onBack:function(b,a){if(a.data.depth==1){this.getBtnGoToMagazines().show()}}});Ext.define("Judge.view.Magazine",{extend:"Ext.Container",xtype:"magazines",requires:["Judge.view.Login","Judge.view.Register","Judge.view.MagazinesAvailableList","Judge.view.MagazinesDownloadedList","Judge.view.MagazineEntry"],id:"magazinePanel",config:{layout:"card",title:"Журнал",iconCls:"bookmarks",items:[{xtype:"tabpanel",tabBarPosition:"top",items:[{xtype:"login"},{xtype:"register"}]},{xtype:"tabpanel",tabBarPosition:"top",items:[{xtype:"availablelist"},{xtype:"downloadedlist"}]},{xtype:"magazineentry"}]}});Ext.define("Judge.view.Main",{id:"MainView",extend:"Ext.tab.Panel",requires:["Judge.view.Articles","Judge.view.Magazine","Judge.view.About","Judge.view.NewsList"],fullscreen:true,config:{tabBarPosition:"bottom",items:[{xtype:"articles"},{xtype:"newslist"},{xtype:"magazines"},{xtype:"about"}]}});Ext.define("Judge.controller.ListBaseController",{extend:"Ext.app.Controller",requires:["Judge.model.EntryModel","Judge.model.ListModel","Judge.model.ListItemModel"],config:{refs:{listView:""},control:{listView:{itemtap:"onItemTap"}}},listModelId:undefined,getDetailsCardContent:function(a){return a.data.content},postLaunch:function(b,a){},buildStore:function(b,a){b.setStore(Ext.create("Ext.data.TreeStore",{model:"Judge.model.ListItemModel",defaultRootProperty:"list",root:{list:a,leaf:false}}))},launch:function(){this.callParent(arguments);this.loadData()},loadData:function(){var b=this.getListView();var c=this.listModelId;if(!c){throw"You should specify you model id in derrived class to retrive appropriate data from service!"}var a=this;this.loadModel("Judge.model.ListModel",c,function(d){a.processProperties(d.data.data);a.buildStore(b,d.data.data);a.on({postLaunch:a.postLaunch});a.fireEvent("postLaunch",b,d.data.data)})},processProperties:function(b){var a=this;Ext.each(b,function(e,d,f){if(f[d].id){if(f[d].title==""){f[d].title=f[d].pagetitle}f[d].leaf=(f[d].leaf=="1");var c=f[d].list;if(c){a.processProperties(c)}}else{Ext.Array.remove(f,e)}})},loadModel:function(b,d,a){if(navigator.network&&navigator.network.connection&&navigator.network.connection.type!=Connection.NONE){try{Ext.ModelMgr.getModel(b).load(d,{success:a,failure:function(){Ext.Msg.alert("Ошибка","Произошла ошибка загрузки данных. Повторите попытку позже.")}})}catch(c){Ext.Msg.alert("Ошибка","Ошибка загрузки данных. Повторите попытку позже.")}finally{}}},onItemTap:function(h,g,a,c,b){if(b.get("leaf")==true){var f=h.getDetailCard();var e=b.get("id");var d=this;this.loadModel("Judge.model.EntryModel",e,function(i){f.setHtml(d.getDetailsCardContent(i))})}}});Ext.define("Judge.controller.AboutController",{extend:"Judge.controller.ListBaseController",config:{refs:{listView:"#AboutView"}},listModelId:176});Ext.define("Judge.controller.MagazinesAvailableController",{extend:"Judge.controller.ListBaseController",requires:["Judge.controller.FileProvider"],config:{refs:{listView:"#AvailableList",downloadedListView:"#DownloadedList"},control:{listView:{itemtap:"onAvailableTap"}}},listModelId:179,loggedIn:false,loadModel:function(b,c,a){if(this.loggedIn==true){this.callParent(arguments)}},launch:function(){var d=this;if(navigator.network&&navigator.network.connection&&navigator.network.connection.type!=Connection.NONE){var a={};Ext.create("Judge.controller.FileProvider",{isWriteAccess:false,readCallback:b,fileName:"versions",createFile:false,getFileErrorCallback:c}).processFile();function c(){Ext.create("Judge.controller.FileProvider",{isWriteAccess:false,readCallback:e,fileName:"all",createFile:false,getFileErrorCallback:{}}).processFile();function e(h){var j=JSON.parse(h.target.result);if(j.length>0){var g=0;f();function f(){d.writeVersions(j[g].id,function(){if(g<j.length){g++;d.writeFile(j[g-1].id,f)}})}}}}function b(g){a=g.target.result.length>0?JSON.parse(g.target.result):{};if(a.versions){function f(h){if(h>=a.versions.length||!a.versions[h]){Ext.create("Judge.controller.FileProvider",{isWriteAccess:true,fileName:"versions",createFile:true,objectToWrite:JSON.stringify(a),getFileErrorCallback:null,readCallback:null,writeCallback:null}).processFile();return}var e=a.versions[h];Ext.Ajax.request({url:"http://evestnik.by/version.html",urlParams:{id:e.id},success:function(i){if(parseInt(e.version)<parseInt(i.responseText)){e.version=i.responseText;Ext.create("Judge.controller.FileProvider",{fileName:e.id,getFileErrorCallback:{}}).deleteFile(function(){d.writeFile(e.id,f.call(this,h+1))})}}})}f(0)}}}this.callParent(arguments)},writeVersions:function(d,c){var a={};Ext.create("Judge.controller.FileProvider",{isWriteAccess:false,readCallback:b,fileName:"versions",createFile:true,getFileErrorCallback:{}}).processFile();function b(f){a=f.target.result.length>0?JSON.parse(f.target.result):{};Ext.Ajax.request({url:"http://evestnik.by/version.html",urlParams:{id:d},success:function(e){if(!a.versions){a.versions=[]}a.versions.push({id:d,version:e.responseText});Ext.create("Judge.controller.FileProvider",{isWriteAccess:true,fileName:"versions",createFile:true,objectToWrite:JSON.stringify(a),getFileErrorCallback:null,readCallback:null,writeCallback:c}).processFile()}})}},writeAllFile:function(d){Ext.create("Judge.controller.FileProvider",{isWriteAccess:false,readCallback:e,fileName:"all",createFile:false,getFileErrorCallback:c}).processFile();function b(f){f.data=null;f.list=null}function a(f){Ext.create("Judge.controller.FileProvider",{isWriteAccess:true,fileName:"all",createFile:f,objectToWrite:JSON.stringify(d),getFileErrorCallback:null,readCallback:null,writeCallback:null}).processFile()}function c(){b(d);d=[d];a(true)}function e(f){var g=JSON.parse(f.target.result);b(d);g.push(d);d=g;a(false)}},buildStore:function(d,c){function b(){d.setStore(Ext.create("Ext.data.Store",{model:"Judge.model.ListItemModel",data:c}))}if(window.LocalFileSystem){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,a,b);function a(e){e.root.getDirectory("magazines",{create:true,exclusive:false},f,b);function f(g){var h=g.createReader();h.readEntries(i,b);function i(j){var k=[];Ext.each(c,function(m){var l=true;Ext.each(j,function(n){if(n.isFile){if(m.id+".txt"==n.name){l=false;return false}}});if(l==true){k.push(m)}});d.setStore(Ext.create("Ext.data.Store",{model:"Judge.model.ListItemModel",data:k}))}}}}else{b()}},onAvailableTap:function(b,c,e,a,d){var f=this;var g=a.get("id");this.writeFile(g,function(i){this.writeAllFile(i);var h=this.getListView().getStore();h.data.each(function(j){if(j.get("id")==i.id){h.remove(j)}});this.getDownloadedListView().getStore().add(i);this.writeVersions(g)})},writeFile:function(b,c){var a=this;if(navigator.network&&navigator.network.connection&&navigator.network.connection.type!=Connection.NONE){Ext.Ajax.request({url:"http://evestnik.by/export.html",urlParams:{id:b},success:function(f){var h=f.responseText.length;var e=0;var g;function d(){if(e*500000<h-1){e++;var i=e*500000;g=f.responseText.substring((e-1)*500000,i);Ext.create("Judge.controller.FileProvider",{objectToWrite:g,isWriteAccess:true,writeCallback:d,fileName:e==1?b:b+"_"+e,createFile:true,getFileErrorCallback:null}).processFile()}else{if(c){var j=JSON.parse(f.responseText);c.call(a,j)}}}d()}})}else{Ext.Msg.alert("Ошибка","Невозможно скачать журнал. Отсутствует подключение к интернету.")}}});Ext.define("Judge.controller.MagazinesDownloadedController",{extend:"Judge.controller.ListBaseController",requires:["Judge.controller.FileProvider"],config:{refs:{listView:"#DownloadedList",magazinePanel:"#magazinePanel",nestedList:"#MagazineEntry"},control:{listView:{itemtap:"onItemTap"}}},listModelId:{},modelReader:null,launch:function(){var b=this.getListView();b.setStore(Ext.create("Ext.data.Store",{model:"Judge.model.ListItemModel",data:[]}));Ext.create("Judge.controller.FileProvider",{isWriteAccess:false,readCallback:a,fileName:"all",createFile:false,getFileErrorCallback:{}}).processFile();function a(c){var d=JSON.parse(c.target.result);Ext.each(d,function(f,e){b.getStore().add(f)})}},onItemTap:function(e,h,d,f,i){var b=f.get("id");var g=this;var a=0;var k=[];function c(l){a++;if(l){k.push(l.target.result)}Ext.create("Judge.controller.FileProvider",{isWriteAccess:false,readCallback:c,fileName:a==1?b:b+"_"+a,createFile:false,getFileErrorCallback:j}).processFile()}function j(){var l=JSON.parse(k.join(""));g.processProperties(l.data);g.buildStore(g.getNestedList(),l.data);g.getMagazinePanel().setActiveItem(2);return}c()}});Ext.define("Judge.controller.ListCarouselController",{extend:"Judge.controller.ListBaseController",config:{refs:{listView:""},control:{listView:{itemtap:"onItemTap"}}},onCarouselIndexChange:function(a,e,b,c){if(e.getHtml()==""){var d=this;var f=e.getId();this.loadModel("Judge.model.EntryModel",f,function(g){e.setHtml(d.getDetailsCardContent(g))})}},postLaunch:function(e,a){if(a){var d=e.getDetailCard();var c=this;d.on({activeitemchange:c.onCarouselIndexChange,scope:this});for(var b=0;b<a.length;b++){d.insert(b,{xtype:"panel",layout:"card",scrollable:{direction:"vertical",directionLock:true},html:"",id:a[b].id})}}},onItemTap:function(a,f,e,b,h){if(h.get("leaf")==true){var i=a.getDetailCard();var c=i.getItems().items[e];if(c.getHtml()==""){var g=h.get("id");var d=this;this.loadModel("Judge.model.EntryModel",g,function(j){c.setHtml(d.getDetailsCardContent(j));i.setActiveItem(e)})}else{i.setActiveItem(e)}}}});Ext.define("Judge.controller.NewsController",{extend:"Judge.controller.ListCarouselController",config:{refs:{listView:"#newsList",xtype:"newslist",autoCreate:true}},listModelId:174});Ext.define("Judge.controller.ArticlesController",{extend:"Judge.controller.ListCarouselController",config:{refs:{listView:"#ArticlesView",xtype:"articles",autoCreate:true}},listModelId:175});Ext.application({name:"Judge",isIconPrecomposed:true,views:["Main"],controllers:["NewsController","ArticlesController","LoginController","AboutController","MagazinesAvailableController","MagazinesDownloadedController","MagazineEntryController"],phoneStartupScreen:"resources/loading/Homescreen.jpg",tabletStartupScreen:"resources/loading/Homescreen~ipad.jpg",launch:function(){Ext.fly("appLoadingIndicator").destroy();if(navigator.network&&navigator.network.connection){if(navigator.network.connection.type==Connection.NONE){Ext.Msg.alert(GlobalMessages.ErrorTitle,GlobalMessages.NoInetOfflineMode)}else{var a=Ext.create("Ext.LoadMask",{message:GlobalMessages.LoadingData,id:"loading"});Ext.Viewport.add(a);Ext.Ajax.on("beforerequest",function(){a.show()});Ext.Ajax.on("requestcomplete",function(){a.hide()});Ext.Ajax.on("requestexception",function(){a.hide()})}}Ext.Viewport.add(Ext.create("Judge.view.Main"))},onUpdated:function(){window.location.reload()}});